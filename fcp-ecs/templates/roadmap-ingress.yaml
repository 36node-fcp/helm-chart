{{- if .Values.ingress.enabled -}}
  {{- if .Values.roadmap.enabled }}

# Note: in a kubernetes secret the string (e.g. generated by htpasswd) must be base64-encoded first.
# To create an encoded user:password pair, the following command can be used:
# htpasswd -nb user password | openssl base64
# Or create a new file with the credentials you want and then convert it when your are done
# htpasswd -c auth username
# *enter and reenter password*
# htpasswd auth username2
# *enter and reenter password*
# base64 auth
# copy and paste into below
# the |2 should stay regardless of how many users. It is yaml syntax.
# Below are username/passwords test/test and test2/test2
# https://doc.traefik.io/traefik/middlewares/basicauth/
apiVersion: v1
kind: Secret
metadata:
  name: roadmap-basic-auth-secret
data:
  users: |2
    ZmNwLXh3YjokYXByMSRWZUtMVS5aViRIV2RVdGJJQ1pkSTdrUkdYOXFwL1kxCmZjcC1kZXZlbG9wZXI6JGFwcjEkYmZrb3E1RkkkNUkvZ0pmT054dVhrbm9vTmVyMzBOLgo=

---

apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: roadmap-basic-auth
spec:
  basicAuth:
    secret: roadmap-basic-auth-secret

---

apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: roadmap
spec:
  entryPoints:
    - web 
  routes:
    - kind: Rule
      {{- if .Values.host }}
      match: Host(`roadmap.{{ .Values.host }}`)
      {{- end }}
      services:
        - name: api@internal
          kind: TraefikService
      middlewares:
        - name: roadmap-basic-auth

---

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: roadmap
  labels:
    {{- include "fcp-ecs.labels" . | nindent 4 }}
  annotations:
    kubernetes.io/ingress.class: traefik
    traefik.ingress.kubernetes.io/router.middlewares: {{ .Release.Name }}-roadmap-basic-auth@kubernetescrd
spec:
  rules:
    - http:
        paths:
          - path: /roadmap
            pathType: ImplementationSpecific
            backend:
              service:
                name: roadmap
                port:
                  number: 80
      {{- if .Values.host }}
      host: roadmap.{{ .Values.host }}
      {{- end }}

  {{- end }}
{{- end }}
